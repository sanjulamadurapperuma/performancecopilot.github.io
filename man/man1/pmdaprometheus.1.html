<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8'>
<meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'>
<meta content='initial-scale=1' name='viewport'>
<title>Performance Co-Pilot</title>
<link href='/assets/css/screen.css' media='all' rel='stylesheet' type='text/css'>
<link href='/assets/css/master.css' media='all' rel='stylesheet' type='text/css'>
<link href='/images/pcp.ico' rel='shortcut icon' type='image/ico'>

</head>
<body>
<header class='global-header'>
<div class='row'>
<h1 class='global-logo colspan12-6 colspan8-4 colspan6-3 colspan2-1 as-grid'>
<a href='/index.html'>Performance Co-Pilot</a>
</h1>
<nav class='global-header__navigation colspan12-6 colspan8-6 colspan6-4 colspan2-1 as-grid'>
<ul>
<li>
<a href='/features.html'>Features</a>
</li>
<li>
<a href='/documentation.html'>Documentation</a>
</li>
<li>
<a href='/download.html'>Download</a>
</li>
<li>
<a href='/community.html'>Get Involved</a>
</li>
</ul>
</nav>
</div>
</header>

<div class='site-content'>
<div class='how-to is-typeset'>
<div class='row-parent'>
<div class='row'>
<div class='manpage'>
﻿
 <h1>
  PMDAPROMETHEUS
 </h1>
 Section: User Commands  (1)
 <br/>
 <a href="#index">
  Index
 </a>
 <a href="/man">
  Return to Main Contents
 </a>
 <hr/>
 <a name="lbAB">
 </a>
 <h2>
  NAME
 </h2>
 <b>
  pmdaprometheus
 </b>
 - Prometheus PMDA
 <a name="lbAC">
 </a>
 <h2>
  SYNOPSIS
 </h2>
 <b>
  $PCP_PMDAS_DIR/prometheus/pmdaprometheus
 </b>
 [
 <b>
  -D
 </b>
 ]
[
 <b>
  -n
 </b>
 ]
[
 <b>
  -c
 </b>
 <i>
  config
 </i>
 ]
[
 <b>
  -t
 </b>
 <i>
  timeout
 </i>
 ]
[
 <b>
  -u
 </b>
 <i>
  user
 </i>
 ]
 <a name="lbAD">
 </a>
 <h2>
  DESCRIPTION
 </h2>
 <b>
  pmdaprometheus
 </b>
 is a Performance Metrics Domain Agent (PMDA) which
creates PCP metrics from Prometheus endpoints, which provide HTTP based
access to application metrics.
The default
 <i>
  config
 </i>
 directory is
 <b>
  $PCP_PMDAS_DIR/prometheus/config.d/
 </b>
 ,
see
 <b>
  SOURCES
 </b>
 below.
The default URL fetch
 <i>
  timeout
 </i>
 is
 <b>
  2
 </b>
 seconds.
The default
 <i>
  user
 </i>
 , if not specified with the
 <b>
  -u
 </b>
 option,
is the current user.
If the
 <b>
  -n
 </b>
 option is given, the list of configuration files will not be sorted prior to processing.
This list is sorted by default but that can be expensive if there are a large number of
configuration files (URLs and/or scripts).
 <p>
  If the
  <b>
   -D
  </b>
  option is given, additional diagnostic messages will be written to the PMDA log file,
which is
  <b>
   $PCP_LOG_DIR/pmcd/prometheus.log
  </b>
  by default.
 </p>
 <p>
  Further details on the Prometheus exposition format can be found at
  <i>
   <a href="https://prometheus.io/docs/instrumenting/exposition_formats">
    https://prometheus.io/docs/instrumenting/exposition_formats
   </a>
  </i>
 </p>
 <p>
  <a name="lbAE">
  </a>
 </p>
 <h2>
  CONFIGURATION SOURCES
 </h2>
 As it runs,
 <b>
  pmdaprometheus
 </b>
 periodically recursively scans the
 <i>
  $PCP_PMDAS_DIR/prometheus/config.d
 </i>
 directory (or the directory specified with the
 <b>
  -c
 </b>
 option), looking for source URL files (
 <i>
  *.url
 </i>
 )

and executable scripts or binaries.
Any files that do not have the
 <b>
  .url
 </b>
 suffix or are not executable, are ignored - this allows documentation files
such as "README" and non-executable "common" script function definitions to
be present without being considered as config files.
 <a name="lbAF">
 </a>
 <h2>
  URL SOURCES
 </h2>
 Each
 <b>
  .url
 </b>
 file found in the config directory or sub-directory contains
one complete HTTP or HTTPS URL at which pmdaprometheus can reach a Prometheus endpoint.
Local file access is also supported with a conventional
 <i>
  <a href="file://somepath/somefile">
   file://somepath/somefile
  </a>
 </i>
 URL, in which case
 <i>
  somepath/somefile
 </i>
 should contain prometheus formatted metric data.
 <p>
  A remote server does not have to be up or stay running - the PMDA tolerates
remote URLs that may come and go over time.
The PMDA will relay data and metadata when/if they are available,
and will return errors when/if they are down.
PCP metric IDs and instance domain names and IDs are saved and persistently
restored when individual metric sources become available and/or when the
PMDA is restarted.
  <a name="lbAG">
  </a>
 </p>
 <h2>
  SCRIPTED SOURCES
 </h2>
 Likewise, executable scripts present in the
 <i>
  $PCP_PMDAS_DIR/prometheus/config.d
 </i>
 directory or sub-directories will be executed and the
 <b>
  stdout
 </b>
 stream containing prometheus formatted metric data will be parsed as though it had come from a URL or file. 
The
 <b>
  stderr
 </b>
 stream from a script will be sent to the PMDA log file, which by default can be found in
 <b>
  $(PCP_LOG_DIR)/pmcd/prometheus.log
 </b>
 .
 <p>
  A simple example of a scripted config entry follows:
 </p>
 <pre>

#! /bin/sh
awk '{
    print("# HELP loadavg local load average")
    print("# Type loadavg gauge")
    printf("loadavg {interval=\"1-minute\"} %.2f\n", $1)
    printf("loadavg {interval=\"5-minute\"} %.2f\n", $2)
    printf("loadavg {interval=\"15-minute\"} %.2f\n", $3)
}' /proc/loadavg
</pre>
 <p>
  This script produces the following prometheus formatted metric data when run :
 </p>
 <pre>

# HELP loadavg local load average
# Type loadavg gauge
loadavg {interval="1-minute"} 0.12
loadavg {interval="5-minute"} 0.27
loadavg {interval="15-minute"} 0.54
</pre>
 <p>
  If the above script was saved and made executable in a file named (assuming default settings)
  <b>
   /var/lib/pcp/pmdas/prometheus/config.d/local/system.sh
  </b>
  then this would result in a new PCP metric named
  <b>
   prometheus.local.system.loadavg
  </b>
  which would have three instances for the current load average values:
  <b>
   1-minute
  </b>
  ,
  <b>
   5-minute
  </b>
  and
  <b>
   15-minute
  </b>
  .
 </p>
 <p>
  Scripted config entries may produce more than one PCP leaf metric name.
For example, the above "system.sh" script could also export other metrics
such as CPU statistics, by reading
  <b>
   /proc/stat
  </b>
  on the local system.
Such additional metrics would appear as peer metrics in the
same PCP metric subtree.
In the case of CPU counters, the metric type definition should be
  <b>
   counter
  </b>
  ,

not
  <b>
   guage
  </b>
  .

For full details of the prometheus exposition formats, see
  <i>
   <a href="https://prometheus.io/docs/instrumenting/exposition_formats">
    https://prometheus.io/docs/instrumenting/exposition_formats
   </a>
  </i>
  .
 </p>
 <p>
  <a name="lbAH">
  </a>
 </p>
 <h2>
  METRIC NAMING
 </h2>
 All metrics from a file named
 <i>
  FOO
 </i>
 .*

will be exported as PCP metrics with the
 <i>
  prometheus.FOO
 </i>
 metric name prefix.
Therefore, the FOO name must be a valid non-leaf name for PCP PMNS metric names.
If the
 <i>
  FOO
 </i>
 name has multiple dot-separated components, the resulting
PMNS names will include those components and care is needed to ensure
there are no overlapping definitions, e.g. metrics returned by
 <b>
  foo.bar.url
 </b>
 may overlap or conflict with metrics returned by
 <b>
  foo.bar.baz.url
 </b>
 .
 <p>
  Config file entries (URLs or scripts) found in subdirectories of the config directory
will also result in hierarical metric names.
For example, a config file named
  <b>
   /var/lib/pcp/pmda/prometheus/config.d/mysource/latency/get.url
  </b>
  will result in metrics being created (by fetching that source URL) below
  <b>
   prometheus.mysource.latency.get
  </b>
  in the PCP namespace.
Scripts found in subdirectories of the config directory similarly result in hirarchical
PCP metric names.
  <a name="lbAI">
  </a>
 </p>
 <h2>
  DYNAMIC METRIC NAMES
 </h2>
 As described above, changes and new additions can be made to files in the configuration
directory without having to restart the PMDA.
These changes are detected automatically and the PCP metric names below
 <b>
  prometheus
 </b>
 in the PMNS will be updated accordingly, i.e. new metrics will be dynamically added and/or existing metrics removed.
In addition, the
 <b>
  prometheus
 </b>
 PMDA honors the
 <b>
  PMCD_NAMES_CHANGE
 </b>
 protocol that was inntroduced in PCP version 4.0 and later.
This protocol extension is only recognised by PCP version 4 clients.
In particular, if
 <b>
  prometheus
 </b>
 metrics are being logged by a PCP v4.0 or later
 <b>
  <a href="/man/man1/pmlogger.1.html">
   pmlogger
  </a>
 </b>
 (1),

new metrics that appear as a result of changes in the PMDA configuration directory
will automatically start to be logged, provided the root of the
 <b>
  prometheus
 </b>
 PMDA namespace is configured for logging in the
 <b>
  pmlogger
 </b>
 configuration file.
See
 <b>
  <a href="/man/man1/pmlogger.1.html">
   pmlogger
  </a>
 </b>
 (1)

for details.
An example of such a
 <b>
  pmlogger
 </b>
 configuration file is :
 <pre>

log mandatory on 2 second {
        # log all metrics below the root of the prometheus namespace
        prometheus
}
</pre>
 <p>
  <a name="lbAJ">
  </a>
 </p>
 <h2>
  CONTROL METRICS
 </h2>
 The PMDA maintains three special control metrics, as described below.
Each of these metrics is a counter and has one instance for each configured metric source.
The instance domain is adjusted dynamically as new sources are discovered.
If there are no sources configured, the metric names are still defined
but the instance domain will be empty and a fetch will return no values.
 <dl compact="">
  <dt>
   <b>
    prometheus.control.calls
   </b>
  </dt>
  <dd>
   The total number of times each configured metric source has been fetched (if it's a URL)
or executed (if it's a script), since the PMDA started.
  </dd>
  <dt>
   <b>
    prometheus.control.fetch_time
   </b>
  </dt>
  <dd>
   Total time in milliseconds that each configured metric source has taken to return a document,
excluding the time to parse the document.
  </dd>
  <dt>
   <b>
    prometheus.control.parse_time
   </b>
  </dt>
  <dd>
   Total time in milliseconds that each configured metric source has taken to parse each document,
excluding the time to fetch the document.
  </dd>
 </dl>
 <p>
  When converted to a rate, the
  <b>
   calls
  </b>
  metric represents the average fetch rate of each source
over the sampling interval (time delta between samples).
The
  <b>
   fetch_time
  </b>
  and
  <b>
   parse_time
  </b>
  counters, when converted to a rate, represent the
average fetch and parsing latency (respectfully), during the sampling interval.
 </p>
 <p>
  <a name="lbAK">
  </a>
 </p>
 <h2>
  LIMITATIONS
 </h2>
 <b>
  pmdaprometheus
 </b>
 and
 <b>
  libpcp
 </b>
 internals impose some numerical constraints about the number of sources (4095),
metrics (1024) within each source, and instance domain instances for each
metric (4194304).
 <p>
 </p>
 <p>
  <a name="lbAL">
  </a>
 </p>
 <h2>
  INSTALLATION
 </h2>
 Install the Prometheus PMDA by using the Install script as root:
 <p>
  <br/>
  # cd $PCP_PMDAS_DIR/prometheus
  <br/>
  <br/>
  # ./Install
 </p>
 <p>
  To uninstall, do the following as root:
 </p>
 <p>
  <br/>
  # cd $PCP_PMDAS_DIR/prometheus
  <br/>
  <br/>
  # ./Remove
 </p>
 <p>
  <b>
   pmdaprometheus
  </b>
  is launched by
  <i>
   <a href="/man/man1/pmcd.1.html">
    pmcd
   </a>
  </i>
  (1) and should never be executed
directly. The Install and Remove scripts notify
  <i>
   <a href="/man/man1/pmcd.1.html">
    pmcd
   </a>
  </i>
  (1) when the
agent is installed or removed.
 </p>
 <p>
  When scripts and .url files are added, removed or changed in the configuration directory,
it is usually not necessary to restart the PMDA - the changes should be detected and
managed on subsequent PCP requests to the PMDA.
  <a name="lbAM">
  </a>
 </p>
 <h2>
  FILES
 </h2>
 <dl compact="">
  <dt>
   <b>
    $PCP_PMDAS_DIR/prometheus/Install
   </b>
  </dt>
  <dd>
   installation script for the
   <b>
    pmdaprometheus
   </b>
   agent
  </dd>
  <dt>
   <b>
    $PCP_PMDAS_DIR/prometheus/Remove
   </b>
  </dt>
  <dd>
   undo installation script for the
   <b>
    pmdaprometheus
   </b>
   agent
  </dd>
  <dt>
   <b>
    $PCP_PMDAS_DIR/prometheus/config.d/
   </b>
  </dt>
  <dd>
   contains URLs and scripts used by the
   <b>
    pmdaprometheus
   </b>
   agent as sources of prometheus metric data.
  </dd>
  <dt>
   <b>
    $PCP_LOG_DIR/pmcd/prometheus.log
   </b>
  </dt>
  <dd>
   default log file for error messages from
   <b>
    pmdaprometheus
   </b>
  </dd>
  <dt>
   <b>
    $PCP_VAR_DIR/config/144.*
   </b>
  </dt>
  <dd>
   files containing internal tables for metric and instance ID number persistence (domain 144).
   <p>
   </p>
  </dd>
 </dl>
 <a name="lbAN">
 </a>
 <h2>
  PCP ENVIRONMENT
 </h2>
 Environment variables with the prefix
 <b>
  PCP_
 </b>
 are used to parameterize
the file and directory names used by
 <b>
  PCP
 </b>
 . On each installation, the
file
 <b>
  /etc/pcp.conf
 </b>
 contains the local values for these variables.
The
 <b>
  $PCP_CONF
 </b>
 variable may be used to specify an alternative
configuration file, as described in
 <i>
  <a href="/man/man5/pcp.conf.5.html">
   pcp.conf
  </a>
 </i>
 (5).
 <a name="lbAO">
 </a>
 <h2>
  SEE ALSO
 </h2>
 <b>
  <a href="/man/man1/pmcd.1.html">
   pmcd
  </a>
 </b>
 (1),
 <b>
  <a href="/man/man1/pminfo.1.html">
   pminfo
  </a>
 </b>
 (1),
 <b>
  <a href="/man/man1/pmlogger.1.html">
   pmlogger
  </a>
 </b>
 (1),
 <b>
  <a href="/man/man1/pmwebd.1.html">
   pmwebd
  </a>
 </b>
 (1),

and
 <i>
  <a href="https://prometheus.io/docs/instrumenting/exposition_formats">
   https://prometheus.io/docs/instrumenting/exposition_formats
  </a>
 </i>
 .
 <p>
 </p>
 <hr/>
 <a name="index">
 </a>
 <h2>
  Index
 </h2>
 <dl>
  <dt>
   <a href="#lbAB">
    NAME
   </a>
  </dt>
  <dd>
  </dd>
  <dt>
   <a href="#lbAC">
    SYNOPSIS
   </a>
  </dt>
  <dd>
  </dd>
  <dt>
   <a href="#lbAD">
    DESCRIPTION
   </a>
  </dt>
  <dd>
  </dd>
  <dt>
   <a href="#lbAE">
    CONFIGURATION SOURCES
   </a>
  </dt>
  <dd>
  </dd>
  <dt>
   <a href="#lbAF">
    URL SOURCES
   </a>
  </dt>
  <dd>
  </dd>
  <dt>
   <a href="#lbAG">
    SCRIPTED SOURCES
   </a>
  </dt>
  <dd>
  </dd>
  <dt>
   <a href="#lbAH">
    METRIC NAMING
   </a>
  </dt>
  <dd>
  </dd>
  <dt>
   <a href="#lbAI">
    DYNAMIC METRIC NAMES
   </a>
  </dt>
  <dd>
  </dd>
  <dt>
   <a href="#lbAJ">
    CONTROL METRICS
   </a>
  </dt>
  <dd>
  </dd>
  <dt>
   <a href="#lbAK">
    LIMITATIONS
   </a>
  </dt>
  <dd>
  </dd>
  <dt>
   <a href="#lbAL">
    INSTALLATION
   </a>
  </dt>
  <dd>
  </dd>
  <dt>
   <a href="#lbAM">
    FILES
   </a>
  </dt>
  <dd>
  </dd>
  <dt>
   <a href="#lbAN">
    PCP ENVIRONMENT
   </a>
  </dt>
  <dd>
  </dd>
  <dt>
   <a href="#lbAO">
    SEE ALSO
   </a>
  </dt>
  <dd>
  </dd>
 </dl>
 
</div>
</div>
</div>
</div>
</div>
<footer class='global-footer is-typeset'>
<div class='row-parent'>
<div class='row'>
<section class='row__colspaced'>
<div class='colspan12-3 colspan8-2 colspan6-2 colspan2-2 as-grid with-gutter'>
<div class='col__module'>
<h4>Main Menu</h4>
<ul>
<li>
<a href='/features.html'>Features</a>
</li>
<li>
<a href='/documentation.html'>Documentation</a>
</li>
<li>
<a class='download' href='/download.html'>Download</a>
</li>
</ul>
</div>
</div>
<div class='colspan12-3 colspan8-2 colspan6-2 colspan2-2 as-grid with-gutter'>
<div class='col__module'>
<h4>Developers</h4>
<ul>
<li>
<a href='https://github.com/performancecopilot/pcp/issues'>Report an issue</a>
</li>
<li>
<a href='https://www.pcp.io/roadmap'>Roadmap</a>
</li>
<li>
<a href='/community.html'>Contributing</a>
</li>
<li>
<a href='/team.html'>Team</a>
</li>
</ul>
</div>
</div>
<div class='colspan12-3 colspan8-2 colspan6-2 colspan2-2 as-grid with-gutter'>
<div class='col__module'>
<h4>About</h4>
<ul>
<li>
<a href='/testimonials.html'>Testimonials</a>
</li>
<li>
<a href='/faq.html'>FAQ</a>
</li>
<li>
<a href='/website.html'>Website</a>
</li>
</ul>
</div>
</div>
<div class='colspan12-3 colspan8-2 colspan6-2 colspan2-2 as-grid with-gutter'>
<div class='col__module'>
<h4>Get Social</h4>
<ul>
<li>
<a class='twitter' href='https://twitter.com/performancepcp' rel='external'>Twitter</a>
</li>
<li>
<a class='github' href='https://github.com/performancecopilot' rel='external'>Github</a>
</li>
</ul>
</div>
</div>
</section>
</div>
<div class='row'>
<div class='colspan2-2'>
<p class='legal'>
This website is Copyright &copy; 2000-2004 Silicon Graphics Inc, 2007-2010 Aconex, 2012-2018 Red Hat
</p>
</div>
</div>
</div>
</footer>

</body>
</html>
